{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="max-w-md mx-auto mt-8 p-6 bg-white rounded-lg shadow-md">
    <div class="text-center mb-6">
        <div class="inline-block p-4 bg-gradient-to-br from-blue-100 to-indigo-100 rounded-full mb-4">
            <svg class="w-16 h-16 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                      d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
            </svg>
        </div>
        <h2 class="text-2xl font-bold mb-2">Check Your Email</h2>
        <p class="text-gray-600">
            We've sent a 6-digit verification code to
        </p>
        <p class="text-blue-600 font-semibold text-lg mt-1">
            {{ email }}
        </p>
    </div>
    
    {% if messages %}
        {% for message in messages %}
            <div class="mb-4 p-4 rounded-lg {% if message.tags == 'error' %}bg-red-50 text-red-700 border-l-4 border-red-500{% else %}bg-green-50 text-green-700 border-l-4 border-green-500{% endif %}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}
    
    <form method="post" id="otpForm">
        {% csrf_token %}
        <input type="hidden" name="verify_otp" value="1">
        
        <div class="mb-6">
            <label class="block text-gray-700 font-semibold mb-3 text-center text-lg">
                Enter Verification Code
            </label>
            
            <!-- 6-digit OTP input -->
            <div class="flex justify-center gap-2 mb-4">
                <input type="text" maxlength="1" 
                       class="otp-input w-12 h-14 text-center text-2xl font-bold border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                       data-index="0" autofocus>
                <input type="text" maxlength="1" 
                       class="otp-input w-12 h-14 text-center text-2xl font-bold border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                       data-index="1">
                <input type="text" maxlength="1" 
                       class="otp-input w-12 h-14 text-center text-2xl font-bold border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                       data-index="2">
                <input type="text" maxlength="1" 
                       class="otp-input w-12 h-14 text-center text-2xl font-bold border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                       data-index="3">
                <input type="text" maxlength="1" 
                       class="otp-input w-12 h-14 text-center text-2xl font-bold border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                       data-index="4">
                <input type="text" maxlength="1" 
                       class="otp-input w-12 h-14 text-center text-2xl font-bold border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                       data-index="5">
            </div>
            
            <!-- Hidden input for actual OTP submission -->
            <input type="hidden" name="otp_code" id="otpCode">
            
            <div class="flex items-center justify-center gap-2 text-sm text-gray-500">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span>Code expires in 10 minutes</span>
            </div>
        </div>
        
        <button type="submit" id="verifyBtn" disabled
                class="w-full bg-green-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-green-700 transition duration-200 shadow-lg disabled:bg-gray-400 disabled:cursor-not-allowed">
            <span id="btnText">âœ“ Verify & Complete Registration</span>
            <span id="btnLoader" class="hidden">
                <svg class="animate-spin inline w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Verifying...
            </span>
        </button>
    </form>
    
    <div class="mt-6 text-center">
        <p class="text-sm text-gray-600 mb-2">
            Didn't receive the code?
        </p>
        <a href="{% url 'user_register' %}" 
           class="text-blue-600 hover:underline text-sm font-semibold inline-flex items-center gap-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
            Resend Code
        </a>
    </div>
    
    <div class="mt-6 p-4 bg-yellow-50 border-l-4 border-yellow-400 rounded">
        <div class="flex gap-2">
            <svg class="w-5 h-5 text-yellow-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <div>
                <p class="text-sm text-yellow-700 font-semibold">
                    Can't find the email?
                </p>
                <p class="text-xs text-yellow-600 mt-1">
                    Check your spam or junk folder. The email should arrive within 1-2 minutes.
                </p>
            </div>
        </div>
    </div>
</div>

<script>
// OTP Input Handling
const otpInputs = document.querySelectorAll('.otp-input');
const otpCodeInput = document.getElementById('otpCode');
const verifyBtn = document.getElementById('verifyBtn');
const btnText = document.getElementById('btnText');
const btnLoader = document.getElementById('btnLoader');
const form = document.getElementById('otpForm');

otpInputs.forEach((input, index) => {
    // Only allow numbers
    input.addEventListener('input', function(e) {
        this.value = this.value.replace(/[^0-9]/g, '');
        
        // Move to next input if current is filled
        if (this.value.length === 1 && index < otpInputs.length - 1) {
            otpInputs[index + 1].focus();
        }
        
        // Update hidden input and check if all filled
        updateOTPCode();
    });
    
    // Handle backspace
    input.addEventListener('keydown', function(e) {
        if (e.key === 'Backspace' && this.value === '' && index > 0) {
            otpInputs[index - 1].focus();
        }
    });
    
    // Handle paste
    input.addEventListener('paste', function(e) {
        e.preventDefault();
        const pastedData = e.clipboardData.getData('text').replace(/[^0-9]/g, '');
        
        // Fill inputs with pasted data
        for (let i = 0; i < Math.min(pastedData.length, 6); i++) {
            if (otpInputs[i]) {
                otpInputs[i].value = pastedData[i];
            }
        }
        
        // Focus last filled input
        const lastIndex = Math.min(pastedData.length, 6) - 1;
        if (otpInputs[lastIndex]) {
            otpInputs[lastIndex].focus();
        }
        
        updateOTPCode();
    });
});

function updateOTPCode() {
    let otp = '';
    otpInputs.forEach(input => {
        otp += input.value;
    });
    
    otpCodeInput.value = otp;
    
    // Enable button if all 6 digits entered
    if (otp.length === 6) {
        verifyBtn.disabled = false;
        verifyBtn.classList.remove('disabled:bg-gray-400');
    } else {
        verifyBtn.disabled = true;
    }
}

// Form submission
form.addEventListener('submit', function(e) {
    verifyBtn.disabled = true;
    btnText.classList.add('hidden');
    btnLoader.classList.remove('hidden');
});

// Auto-focus first input
otpInputs[0].focus();
</script>
{% endblock %}